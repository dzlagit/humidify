@page "/contact"
@using System.Net.Http.Json
@using System.ComponentModel.DataAnnotations
@using humidify.Core.Models

<PageTitle>Contact Us</PageTitle>

<div class="container mt-5">
    <h1 class="text-white mb-4">Contact Us</h1>
    <div class="row">
        <div class="col-lg-8">
            <EditForm Model="@ContactForm" OnValidSubmit="@HandleSubmit" class="p-4 rounded-lg bg-dark-transparent">
                <DataAnnotationsValidator />

                <div class="mb-3">
                    <label for="Name" class="form-label">Name</label>
                    <InputText id="Name" @bind-Value="ContactForm.Name" class="form-control" placeholder="Your Name" />
                    <ValidationMessage For="@(() => ContactForm.Name)" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="Email" class="form-label">Email</label>
                    <InputText id="Email" @bind-Value="ContactForm.Email" class="form-control" placeholder="Your Email" />
                    <ValidationMessage For="@(() => ContactForm.Email)" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="Message" class="form-label">Message</label>
                    <InputTextArea id="Message" @bind-Value="ContactForm.Message" class="form-control" rows="5" placeholder="Your Message" />
                    <ValidationMessage For="@(() => ContactForm.Message)" class="text-danger" />
                </div>

                <button type="submit" class="btn btn-primary btn-lg">
                    @if (isSubmitting)
                    {
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                        }
                    else
                    {
                        <span>Send Message</span>
                    }
                </button>
            </EditForm>

            @if (!string.IsNullOrEmpty(Message))
            {
                <div class="mt-4 alert @statusClass" role="alert">
                    @Message
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Inject]
    private IHttpClientFactory HttpClientFactory { get; set; } = default!;

    // Uses ContactMessage DTO from the humidify.Core.Models namespace
    private ContactMessage ContactForm = new();
    private string Message = string.Empty;
    private string statusClass = string.Empty;
    private bool isSubmitting = false;

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        Message = "Sending...";
        statusClass = "alert-info";

        var client = HttpClientFactory.CreateClient("Api");

        try
        {
            var response = await client.PostAsJsonAsync("api/contact", ContactForm);

            if (response.IsSuccessStatusCode)
            {
                Message = "Message sent successfully! (Check your API console for the logged message.)";
                statusClass = "alert-success";
                ContactForm = new ContactMessage();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Message = $"Failed to send message (Status: {(int)response.StatusCode} {response.ReasonPhrase}). Error: {errorContent}";
                statusClass = "alert-danger";
            }
        }
        catch (HttpRequestException httpEx)
        {
            Message = $"A network error occurred. Check if the API is running at {client.BaseAddress}. Error: {httpEx.Message}";
            statusClass = "alert-danger";
        }
        catch (Exception ex)
        {
            Message = $"An unexpected error occurred: {ex.Message}";
            statusClass = "alert-danger";
        }
        finally
        {
            isSubmitting = false;
        }
    }
}